---
sidebar: sidebar 
permalink: vmware/vmw-vcf-disaster-recovery-nfs.html 
keywords: netapp, vmware, cloud, foundation, vcf, nfs 
summary: Solução de recuperação de desastres para VCF com NetApp Disaster Recovery. 
---
= Implementando a Recuperação de Desastres com o NetApp Disaster Recovery
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Solução de recuperação de desastres VCF para armazenamento de dados NFS com NetApp SnapMirror e NetApp Disaster Recovery.

A replicação em nível de bloco de um site de produção para um site de recuperação de desastres (DR) oferece uma estratégia resiliente e econômica para proteger cargas de trabalho contra interrupções do site e eventos de corrupção de dados, incluindo ataques de ransomware.  A replicação do NetApp SnapMirror permite que domínios de carga de trabalho do VMware VCF 9 em execução em sistemas ONTAP locais, usando armazenamentos de dados NFS ou VMFS, sejam replicados para um sistema ONTAP secundário localizado em um data center de recuperação designado onde o VMware também está implantado.

Para obter mais informações, consulte o seguinte:link:https://docs.netapp.com/us-en/data-services-disaster-recovery/["Documentação do NetApp Disaster Recovery"] .

Esta seção descreve a configuração do NetApp Disaster Recovery para estabelecer a recuperação de desastres (DR) para máquinas virtuais VMware locais.

A configuração inclui:

* Criar uma conta no NetApp Console e implantar um agente.
* Adicionar arrays ONTAP ao NetApp Console aos sistemas em gerenciamento para facilitar a comunicação entre o VMware vCenter e o armazenamento ONTAP .
* Configurando replicação entre sites usando SnapMirror.
* Configurar e testar um plano de recuperação para validar a prontidão para failover.


O NetApp Disaster Recovery, integrado ao NetApp Console, permite que as organizações descubram facilmente seus sistemas de armazenamento VMware vCenter e ONTAP locais. Uma vez descobertos, os administradores podem definir agrupamentos de recursos, criar planos de recuperação de desastres, associá-los aos recursos apropriados e iniciar ou testar operações de failover e failback. O NetApp SnapMirror fornece replicação eficiente em nível de bloco, garantindo que o site de DR permaneça sincronizado com o ambiente de produção por meio de atualizações incrementais. Isso permite um Objetivo de Ponto de Recuperação (RPO) de apenas cinco minutos.

O NetApp Disaster Recovery também oferece suporte a testes de recuperação de desastres sem interrupção do processo. Aproveitando a tecnologia FlexClone da ONTAP, ele cria cópias temporárias e com eficiência de espaço do armazenamento de dados NFS a partir do Snapshot replicado mais recente, sem impactar as cargas de trabalho de produção ou incorrer em custos adicionais de armazenamento. Após o teste, o ambiente pode ser facilmente desmontado, preservando a integridade dos dados replicados.

Em caso de falha real, o NetApp Console orquestra o processo de recuperação, ativando automaticamente as máquinas virtuais protegidas no site de recuperação de desastres designado, com intervenção mínima do usuário. Quando o site principal é restaurado, o serviço inverte o relacionamento do SnapMirror e replica quaisquer alterações de volta ao site original, permitindo um failback suave e controlado.

Todos esses recursos são fornecidos a um custo significativamente menor em comparação às soluções tradicionais de recuperação de desastres.

image::vmw-vcf-dr-nfs-001.png[Diagrama da arquitetura de NetApp Disaster Recovery]



== Começando

Para começar a usar o NetApp Disaster Recovery, utilize o NetApp Console e acesse o serviço.

. Faça login no NetApp Console.
. Na navegação à esquerda do NetApp Console , selecione Proteção > Recuperação de Desastres.
. O painel de controle de NetApp Disaster Recovery é exibido.
+
image::vmw-vcf-dr-nfs-002.png[Painel de NetApp Disaster Recovery]



Antes de configurar o plano de recuperação de desastres, certifique-se do seguinte:link:https://docs.netapp.com/us-en/data-services-disaster-recovery/get-started/dr-prerequisites.html["pré-requisitos"] são atendidas:

* O agente do Console está configurado no NetApp Console.
* A instância do agente possui conectividade com o domínio de carga de trabalho de origem e destino do vCenter e com os sistemas de armazenamento.
* Cluster NetApp Data ONTAP para fornecer armazenamento de dados NFS ou VMFS.
* Os sistemas de armazenamento NetApp locais que hospedam datastores NFS ou VMFS para VMware são adicionados ao NetApp Console.
* A resolução de DNS deve estar em vigor ao usar nomes DNS. Caso contrário, use endereços IP para o vCenter.
* A replicação do SnapMirror é configurada para os volumes de armazenamento de dados baseados em NFS ou VMFS designados.
* Certifique-se de que o ambiente tenha versões compatíveis dos servidores vCenter Server e ESXi.


Depois que a conectividade for estabelecida entre os sites de origem e destino, prossiga com as etapas de configuração, que devem levar alguns cliques e cerca de 3 a 5 minutos.

Nota: A NetApp recomenda a implementação do agente do Console no site de destino ou em um terceiro site, para que o agente possa se comunicar pela rede com os recursos de origem e destino.

Nesta demonstração, os domínios de carga de trabalho são configurados com armazenamento ONTAP NFS.  As etapas em termos de fluxo de trabalho permanecem as mesmas para armazenamentos de dados baseados em VMFS.

image::vmw-vcf-dr-nfs-003.png[Painel de controle detalhado de NetApp Disaster Recovery]



== Configuração de NetApp Disaster Recovery

O primeiro passo na preparação para a recuperação de desastres é descobrir e adicionar o vCenter de origem e os recursos de armazenamento ao NetApp Disaster Recovery.

Abra o NetApp Console e selecione Proteção > Recuperação de desastres na navegação à esquerda. Selecione os Sites e, em seguida, escolha Adicionar. Insira um nome para o novo site de origem e suas localizações. Repita o passo para adicionar o site e a localização de destino.

image::vmw-vcf-dr-nfs-004.png[Painel de controle detalhado de NetApp Disaster Recovery]

Adicione as seguintes plataformas:

* Domínio de carga de trabalho de origem vCenter
* Domínio de carga de trabalho de destino vCenter.


Depois que os vCenters são adicionados, a descoberta automatizada é acionada.



== Configurando a replicação de armazenamento entre o array do site de origem e o array do site de destino.

O SnapMirror oferece replicação de dados em um ambiente NetApp . Construída com a tecnologia NetApp Snapshot®, a replicação SnapMirror é extremamente eficiente porque replica apenas os blocos que foram alterados ou adicionados desde a atualização anterior. O SnapMirror é facilmente configurado usando o NetApp OnCommand System Manager ou o ONTAP CLI. O NetApp Disaster Recovery também cria a relação SnapMirror, desde que o emparelhamento de cluster e SVM esteja configurado previamente.

Nos casos em que o armazenamento primário não é completamente perdido, o SnapMirror oferece um meio eficiente de ressincronizar os sites primário e de recuperação de desastres (DR). O SnapMirror pode ressincronizar os dois sites, transferindo apenas os dados alterados ou novos de volta para o site primário a partir do site de recuperação de desastres, simplesmente invertendo os relacionamentos do SnapMirror . Isso significa que os planos de replicação no NetApp Disaster Recovery podem ser ressincronizados em qualquer direção após uma falha, sem a necessidade de copiar todo o volume novamente. Se uma relação for ressincronizada na direção inversa, somente os novos dados gravados desde a última sincronização bem-sucedida da cópia do Snapshot serão enviados de volta ao destino.


NOTE: Se o relacionamento SnapMirror já estiver configurado para o volume via CLI ou System Manager, o NetApp Disaster Recovery reconhece o relacionamento e continua com o restante das operações do fluxo de trabalho.



== Como configurar relações de replicação para o NetApp Disaster Recovery

O processo subjacente para criar a replicação do SnapMirror permanece o mesmo para qualquer aplicação.  A maneira mais fácil é utilizar o NetApp Disaster Recovery , que automatizará o fluxo de trabalho de replicação, desde que os dois critérios a seguir sejam atendidos: O processo pode ser manual ou automatizado. A maneira mais fácil é aproveitar o NetApp Disaster Recovery, que automatizará o fluxo de trabalho de replicação, desde que os dois critérios a seguir sejam atendidos:

* Os clusters de origem e destino têm um relacionamento de pares.
* O SVM de origem e o SVM de destino têm um relacionamento de mesmo nível.


O NetApp Console também oferece uma opção alternativa para configurar a replicação SnapMirror , bastando arrastar e soltar o sistema ONTAP de origem no ambiente para o destino, acionando o assistente que orienta o usuário durante o restante do processo.



== O que o NetApp Disaster Recovery pode fazer por você?

Após a adição dos sites de origem e destino, o NetApp Disaster Recovery realiza uma descoberta profunda automática e exibe as VMs juntamente com os metadados associados. O NetApp Disaster Recovery também detecta automaticamente as redes e os grupos de portas usados ​​pelas VMs e os preenche automaticamente.

image::vmw-vcf-dr-nfs-005.png[Sites do NetApp Console]

Após a adição dos sites, configure o plano de replicação selecionando as plataformas vCenter de origem e destino e escolhendo os grupos de recursos a serem incluídos no plano, juntamente com o agrupamento de como os aplicativos devem ser restaurados e ligados, além do mapeamento de clusters e redes. Para definir o plano de recuperação, acesse a guia *Planos de replicação* e clique em *Adicionar*.

Nesta etapa, as VMs podem ser agrupadas em grupos de recursos. Os grupos de recursos do NetApp Disaster Recovery permitem agrupar um conjunto de VMs dependentes em grupos lógicos que contêm suas ordens de inicialização e atrasos de inicialização, os quais podem ser executados durante a recuperação. Os grupos de recursos podem ser criados durante a elaboração do plano de replicação ou através da aba "Grupos de recursos" na navegação à esquerda.

Primeiro, dê um nome ao plano de replicação e selecione o vCenter de origem e o vCenter de destino.

image::vmw-vcf-dr-nfs-006.png[O NetApp Disaster Recovery tem como alvo o vCenter.]

O próximo passo é escolher se você está criando um plano de replicação com grupos de recursos, máquinas virtuais ou armazenamentos de dados. Selecione um grupo de recursos existente e, caso nenhum grupo de recursos tenha sido criado, o assistente ajudará a agrupar as máquinas virtuais necessárias (basicamente, criar grupos de recursos funcionais) com base nos objetivos de recuperação. Isso também ajuda a definir a sequência de operações de como as máquinas virtuais de aplicativos devem ser restauradas.

image::vmw-vcf-dr-nfs-007.png[O NetApp Disaster Recovery seleciona VMs para proteger.]


NOTE: O grupo de recursos permite definir a ordem de inicialização usando a funcionalidade de arrastar e soltar. Ele pode ser usado para modificar facilmente a ordem em que as VMs serão ligadas durante o processo de recuperação.

Após a criação dos grupos de recursos por meio do plano de replicação, o próximo passo é criar o mapeamento para recuperar máquinas virtuais e aplicativos em caso de desastre. Nesta etapa, especifique como os recursos do ambiente de origem são mapeados para o destino. Isso inclui recursos de computação, redes virtuais, personalização de IP, pré e pós-scripts, atrasos de inicialização, consistência de aplicativos e assim por diante. Para obter informações detalhadas, consultelink:https://docs.netapp.com/us-en/data-services-disaster-recovery/use/drplan-create.html#map-source-resources-to-the-target["Crie um plano de replicação"] . Conforme mencionado nos pré-requisitos, a replicação do SnapMirror pode ser configurada antecipadamente ou o DRaaS pode configurá-la usando o RPO e o número de retenções especificados durante a criação do plano de replicação.

Nota: Por padrão, os mesmos parâmetros de mapeamento são usados tanto para operações de teste quanto para operações de failover. Para definir mapeamentos diferentes para o ambiente de teste, selecione a opção Mapeamento de teste após desmarcar a caixa de seleção “Usar os mesmos mapeamentos para failover e mapeamentos de teste”. Após concluir o mapeamento de recursos, clique em Avançar.

image::vmw-vcf-dr-nfs-008.png[Mapeamento de recursos para desastres da NetApp]

Uma vez concluído, revise os mapeamentos criados e clique em Adicionar plano.

image::vmw-vcf-dr-nfs-009.png[Revisão do mapeamento de recursos de NetApp Disaster Recovery]


NOTE: VMs de diferentes volumes e SVMs podem ser incluídas em um plano de replicação. Dependendo da localização da VM (seja no mesmo volume ou em volumes separados dentro da mesma SVM, ou em volumes separados em SVMs diferentes), o NetApp Disaster Recovery cria um Snapshot do Grupo de Consistência.

image::vmw-vcf-dr-nfs-010.png[Planos de replicação de NetApp Disaster Recovery]

Assim que o plano é criado, uma série de validações são acionadas e a replicação e os agendamentos do SnapMirror são configurados conforme a seleção.

image::vmw-vcf-dr-nfs-011.png[Monitoramento de tarefas de NetApp Disaster Recovery]

A NetApp Disaster Recovery consiste nos seguintes fluxos de trabalho:

* Teste de failover (incluindo simulações automatizadas periódicas)
* Teste de failover de limpeza
* Failover:
+
** Migração planejada (estender o caso de uso para failover único)
** Recuperação de desastres


* Failback


image::vmw-vcf-dr-nfs-012.png[Ações do plano de replicação do NetApp Disaster Recovery]



== Teste de failover

O teste de failover no NetApp Disaster Recovery é um procedimento operacional que permite aos administradores do VMware validar completamente seus planos de recuperação sem interromper seus ambientes de produção.

image::vmw-vcf-dr-nfs-013.png[Teste de failover do plano de replicação do NetApp Disaster Recovery]

O NetApp Disaster Recovery incorpora a capacidade de selecionar o snapshot como um recurso opcional na operação de failover de teste. Essa funcionalidade permite ao administrador do VMware verificar se quaisquer alterações feitas recentemente no ambiente foram replicadas para o site de destino e, portanto, estão presentes durante o teste. Essas mudanças incluem patches para o sistema operacional convidado da VM.

image::vmw-vcf-dr-nfs-014.png[Confirmação de failover do teste do plano de replicação do NetApp Disaster Recovery]

Quando o administrador do VMware executa uma operação de failover de teste, o NetApp Disaster Recovery automatiza as seguintes tarefas:

* Acionar relacionamentos do SnapMirror para atualizar o armazenamento no site de destino com quaisquer alterações recentes feitas no site de produção.
* Criação de volumes NetApp FlexClone dos volumes FlexVol no array de armazenamento DR.
* Conectando os datastores nos volumes FlexClone aos hosts ESXi no site de DR.
* Conectando os adaptadores de rede da VM à rede de teste especificada durante o mapeamento.
* Reconfigurando as configurações de rede do sistema operacional convidado da VM, conforme definido para a rede no site de DR.
* Executar quaisquer comandos personalizados que tenham sido armazenados no plano de replicação.
* Ligar as VMs na ordem definida no plano de replicação.


image::vmw-vcf-dr-nfs-015.png[Resultado do teste de failover do plano de replicação do NetApp Disaster Recovery]



== Operação de teste de failover de limpeza

A operação de teste de failover de limpeza ocorre após a conclusão do teste do plano de replicação e o administrador do VMware responde ao prompt de limpeza.

image::vmw-vcf-dr-nfs-016.png[NetApp Disaster Recovery plano de replicação teste failover limpeza]

Essa ação redefinirá as máquinas virtuais (VMs) e o status do plano de replicação para o estado pronto. Quando o administrador do VMware executa uma operação de recuperação, o NetApp Disaster Recovery completa o seguinte processo:

. Ele desliga cada VM recuperada na cópia do FlexClone que foi usada para teste.
. Ele exclui o volume FlexClone que foi usado para apresentar as VMs recuperadas durante o teste.




== Migração planejada e failover

O NetApp Disaster Recovery possui dois métodos para realizar um failover real: migração planejada e failover direto. O primeiro método, migração planejada, incorpora o desligamento da VM e a sincronização da replicação do armazenamento ao processo para recuperar ou mover efetivamente as VMs para o site de destino. A migração planejada requer acesso ao site de origem. O segundo método, failover, é um failover planejado/não planejado no qual as VMs são recuperadas no site de destino a partir do último intervalo de replicação de armazenamento que foi concluído. Dependendo do RPO (Objetivo de Ponto de Recuperação) definido na solução, alguma perda de dados pode ser esperada no cenário de recuperação de desastres.

image::vmw-vcf-dr-nfs-017.png[Ação de failover do plano de replicação do NetApp Disaster Recovery]

image::vmw-vcf-dr-nfs-018.png[Confirmação da ação de failover do plano de replicação do NetApp Disaster Recovery]

Quando o administrador do VMware realiza uma operação de failover, o NetApp Disaster Recovery automatiza as seguintes tarefas:

* Interrompa e faça failover dos relacionamentos do NetApp SnapMirror .
* Conecte os armazenamentos de dados replicados aos hosts ESXi no site de DR.
* Conecte os adaptadores de rede da VM à rede do site de destino apropriada.
* Reconfigure as configurações de rede do sistema operacional convidado da VM, conforme definido para a rede no site de destino.
* Execute quaisquer comandos personalizados (se houver) que tenham sido armazenados no plano de replicação.
* Ligue as VMs na ordem definida no plano de replicação.


image::vmw-vcf-dr-nfs-019.png[vSphere Client - VMs ligadas]



== Failback

Um failback é um procedimento opcional que restaura a configuração original dos sites de origem e destino após uma recuperação.

image::vmw-vcf-dr-nfs-020.png[ação de failback do plano de replicação do NetApp Disaster Recovery]

Os administradores do VMware podem configurar e executar um procedimento de failback quando estiverem prontos para restaurar serviços no site de origem original.


NOTE: O NetApp Disaster Recovery replica (ressincroniza) quaisquer alterações de volta para a máquina virtual de origem original antes de inverter a direção da replicação.

Esse processo começa com um relacionamento que concluiu o failover para um alvo e envolve as seguintes etapas:

* Desligue e cancele o registro das máquinas virtuais e os volumes no site de destino serão desmontados.
+
image::vmw-vcf-dr-nfs-021.png[vSphere Client - tarefas recentes]

* Interrompa o relacionamento SnapMirror na fonte original para torná-lo de leitura/gravação.
* Ressincronize o relacionamento do SnapMirror para reverter a replicação.
* Monte o volume na origem, ligue e registre as máquinas virtuais de origem.
+
image::vmw-vcf-dr-nfs-022.png[vSphere Client - VMs ligadas]



Para obter mais detalhes sobre como acessar e configurar o NetApp Disaster Recovery, consulte olink:https://docs.netapp.com/us-en/data-services-disaster-recovery/get-started/dr-intro.html["Saiba mais sobre o NetApp Disaster Recovery para VMware"] .



== Monitoramento e Painel

A partir do NetApp Disaster Recovery ou da CLI do ONTAP , você pode monitorar o status de integridade da replicação para os volumes de armazenamento de dados apropriados, e o status de um failover ou failover de teste pode ser rastreado por meio do Monitoramento de Tarefas.

image::vmw-vcf-dr-nfs-023.png[Monitoramento de tarefas de NetApp Disaster Recovery]


NOTE: Se um trabalho estiver em andamento ou na fila e você desejar interrompê-lo, há uma opção para cancelá-lo.

Com o painel de controle do NetApp Disaster Recovery , avalie com confiança o status dos sites de recuperação de desastres e dos planos de replicação. Isso permite que os administradores identifiquem rapidamente sites e planos íntegros, desconectados ou degradados.

image::vmw-vcf-dr-nfs-024.png[Painel de controle atualizado para NetApp Disaster Recovery]

Isso fornece uma solução poderosa para lidar com um plano de recuperação de desastres personalizado e personalizado. O failover pode ser feito como failover planejado ou failover com o clique de um botão quando ocorre um desastre e é tomada a decisão de ativar o site de DR.
