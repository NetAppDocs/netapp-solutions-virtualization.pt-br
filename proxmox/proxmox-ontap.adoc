---
sidebar: sidebar 
permalink: proxmox/proxmox-ontap.html 
keywords: netapp, proxmox, proxmox ve, all-flash, nfs, iscsi, ontap, storage, aff 
summary: 'O armazenamento compartilhado no Proxmox Virtual Environment (VE) reduz o tempo de migração ativa da VM e o torna um alvo melhor para backups e modelos consistentes em todo o ambiente.  O armazenamento ONTAP pode atender às necessidades dos ambientes de host Proxmox VE, bem como às demandas de armazenamento de arquivos convidados, blocos e objetos.' 
---
= Provisionar armazenamento ONTAP para o ambiente virtual Proxmox
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Configure o armazenamento ONTAP com o Proxmox Virtual Environment (VE) usando os protocolos NAS, SAN e SMB/CIFS.  O armazenamento compartilhado no Proxmox VE reduz o tempo de migração de VM ativa e fornece um alvo melhor para backup e modelos consistentes em todo o ambiente.

Os hosts Proxmox VE precisam ter interfaces FC, Ethernet ou outras interfaces suportadas conectadas aos switches e ter comunicação com interfaces lógicas ONTAP .  Sempre verifique https://mysupport.netapp.com/matrix/#welcome["Ferramenta de Matriz de Interoperabilidade"] para configurações suportadas.



== Recursos ONTAP de alto nível

*Características comuns*

* Escalar o cluster
* Autenticação segura e suporte RBAC
* Suporte multiadministrativo de confiança zero
* Multilocação Segura
* Replique dados com o SnapMirror.
* Cópias de ponto no tempo com Snapshots.
* Clones com eficiência de espaço.
* Recursos de eficiência de armazenamento como desduplicação, compactação, etc.
* Suporte Trident CSI para Kubernetes
* Snaplock
* Bloqueio de cópia de instantâneo à prova de violação
* Suporte de criptografia
* FabricPool para hierarquizar dados frios no armazenamento de objetos.
* Integração do BlueXP e do CloudInsights.
* Transferência de dados descarregada da Microsoft (ODX)


*NAS*

* Os volumes FlexGroup são um contêiner NAS escalável, que fornece alto desempenho junto com distribuição de carga e escalabilidade.
* O FlexCache permite que os dados sejam distribuídos globalmente e ainda fornece acesso local de leitura e gravação aos dados.
* O suporte multiprotocolo permite que os mesmos dados sejam acessíveis via SMB e NFS.
* O NFS nConnect permite múltiplas sessões TCP por conexão TCP, aumentando a taxa de transferência da rede.  Isso aumenta a utilização de placas de rede de alta velocidade disponíveis em servidores modernos.
* O entroncamento de sessão NFS proporciona maiores velocidades de transferência de dados, alta disponibilidade e tolerância a falhas.
* O multicanal SMB oferece maior velocidade de transferência de dados, alta disponibilidade e tolerância a falhas.
* Integração com Active Directory/LDAP para permissões de arquivo.
* Conexão segura com NFS sobre TLS.
* Suporte a NFS Kerberos.
* NFS sobre RDMA.
* Mapeamento de nomes entre identidades do Windows e do Unix.
* Proteção autônoma contra ransomware.
* Análise do sistema de arquivos.


*SAN*

* Amplie o cluster em domínios de falhas com a sincronização ativa do SnapMirror .
* Os modelos ASA fornecem multicaminhos ativo/ativo e failover de caminho rápido.
* Suporte para protocolos FC, iSCSI, NVMe-oF.
* Suporte para autenticação mútua iSCSI CHAP.
* Mapa de LUN seletivo e conjunto de portas.




== Tipos de armazenamento Proxmox VE suportados com ONTAP

Os protocolos NAS (NFS/SMB) oferecem suporte a todos os tipos de conteúdo do Proxmox VE e normalmente são configurados uma vez no nível do datacenter.  VMs convidadas podem usar discos do tipo raw, qcow2 ou VMDK no armazenamento NAS.  Os instantâneos do ONTAP podem ser tornados visíveis para acessar cópias pontuais dos dados do cliente.  O armazenamento em bloco com protocolos SAN (FC/iSCSI/NVMe-oF) normalmente é configurado por host e é restrito aos tipos de conteúdo de disco de VM e imagem de contêiner suportados pelo Proxmox VE.  VMs convidadas e contêineres consomem armazenamento em bloco como dispositivos brutos.

[cols="25% 15% 15% 15% 15% 15%"]
|===
| Tipo de conteúdo | NFS | PME/CIFS | FC | iSCSI | NVMe-oF 


| Backups | Sim | Sim  a| 
Não^1^
 a| 
Não^1^
 a| 
Não^1^



| Discos de VM | Sim | Sim  a| 
Sim^2^
 a| 
Sim^2^
 a| 
Sim^2^



| Volumes de TC | Sim | Sim  a| 
Sim^2^
 a| 
Sim^2^
 a| 
Sim^2^



| Imagens ISO | Sim | Sim  a| 
Não^1^
 a| 
Não^1^
 a| 
Não^1^



| Modelos de TC | Sim | Sim  a| 
Não^1^
 a| 
Não^1^
 a| 
Não^1^



| Trechos | Sim | Sim  a| 
Não^1^
 a| 
Não^1^
 a| 
Não^1^

|===
*Observações:* 1 - Requer um sistema de arquivos de cluster para criar a pasta compartilhada e usar o tipo de armazenamento Diretório.  2 - use o tipo de armazenamento LVM.



== Armazenamento SMB/CIFS

Para utilizar compartilhamentos de arquivos SMB/CIFS, há certas tarefas que precisam ser executadas pelo administrador de armazenamento e o administrador de virtualização pode montar o compartilhamento usando a interface do usuário do Proxmox VE ou a partir do shell.  O multicanal SMB fornece tolerância a falhas e aumenta o desempenho.  Para mais detalhes, consultelink:https://www.netapp.com/pdf.html?item=/media/17136-tr4740.pdf["TR4740 - SMB 3.0 Multicanal"]


NOTE: A senha será salva em um arquivo de texto simples e acessível somente ao usuário root. Consulte link:https://pve.proxmox.com/pve-docs/chapter-pvesm.html#storage_cifs["Documentação do Proxmox VE"] .

.Pool de armazenamento compartilhado SMB com ONTAP
video::5b4ae54a-08d2-4f7d-95ec-b22d015f6035[panopto,width=360]
.Tarefas de administração de armazenamento
[%collapsible%open]
====
Se você é novo no ONTAP, use a Interface do Gerenciador de Sistema para concluir essas tarefas e ter uma melhor experiência.

. Certifique-se de que o SVM esteja habilitado para SMB.  Seguirlink:https://docs.netapp.com/us-en/ontap/smb-config/configure-access-svm-task.html["Documentação do ONTAP 9"] para maiores informações.
. Tenha pelo menos duas vidas por controlador.  Siga os passos do link acima.  Para referência, aqui está uma captura de tela do lifs usado nesta solução.
+
image:proxmox-ontap-001.png["detalhes da interface nas"]

. Use a autenticação baseada no Active Directory ou no grupo de trabalho.  Siga os passos do link acima.
+
image:proxmox-ontap-002.png["Junte-se às informações do domínio"]

. Crie um volume.  Lembre-se de marcar a opção de distribuir dados pelo cluster para usar o FlexGroup.
+
image:proxmox-ontap-023.png["Opção FlexGroup"]

. Crie um compartilhamento SMB e ajuste as permissões.  Seguirlink:https://docs.netapp.com/us-en/ontap/smb-config/configure-client-access-shared-storage-concept.html["Documentação do ONTAP 9"] para maiores informações.
+
image:proxmox-ontap-003.png["Informações de compartilhamento de PMEs"]

. Forneça o servidor SMB, o nome do compartilhamento e as credenciais ao administrador de virtualização para que ele conclua a tarefa.


====
.Tarefas de administração de virtualização
[%collapsible%open]
====
. Colete o servidor SMB, o nome do compartilhamento e as credenciais a serem usadas para autenticação do compartilhamento.
. Certifique-se de que pelo menos duas interfaces estejam configuradas em VLANs diferentes (para tolerância a falhas) e que a NIC suporte RSS.
. Se estiver usando a interface de gerenciamento `https:<proxmox-node>:8006` , clique em datacenter, selecione armazenamento, clique em Adicionar e selecione SMB/CIFS.
+
image:proxmox-ontap-004.png["Navegação de armazenamento SMB"]

. Preencha os detalhes e o nome do compartilhamento deverá ser preenchido automaticamente.  Certifique-se de que todo o conteúdo esteja selecionado.  Clique em Adicionar.
+
image:proxmox-ontap-005.png["Adição de armazenamento SMB"]

. Para habilitar a opção multicanal, acesse o shell em qualquer um dos nós do cluster e digite pvesm set pvesmb01 --options multichannel,max_channels=4
+
image:proxmox-ontap-006.png["configuração multicanal"]

. Aqui está o conteúdo em /etc/pve/storage.cfg para as tarefas acima.
+
image:proxmox-ontap-007.png["arquivo de configuração de armazenamento para SMB"]



====


== Armazenamento NFS

O ONTAP suporta todas as versões do NFS suportadas pelo Proxmox VE.  Para fornecer tolerância a falhas e melhorias de desempenho, garantalink:https://docs.netapp.com/us-en/ontap/nfs-trunking/index.html["entroncamento de sessão"] é utilizado.  Para usar o entroncamento de sessão, é necessário no mínimo NFS v4.1.

Se você é novo no ONTAP, use a Interface do Gerenciador de Sistema para concluir essas tarefas e ter uma melhor experiência.

.Opção NFS nconnect com ONTAP
video::f6c9aba3-b070-45d6-8048-b22e001acfd4[panopto,width=360]
.Tarefas de administração de armazenamento
[%collapsible%open]
====
. Certifique-se de que o SVM esteja habilitado para NFS. Consulte link:https://docs.netapp.com/us-en/ontap/nfs-config/verify-protocol-enabled-svm-task.html["Documentação do ONTAP 9"]
. Tenha pelo menos duas vidas por controlador.  Siga os passos do link acima.  Para referência, aqui está a captura de tela do lifs que usamos em nosso laboratório.
+
image:proxmox-ontap-001.png["detalhes da interface nas"]

. Crie ou atualize a política de exportação NFS fornecendo acesso aos endereços IP ou sub-rede do host Proxmox VE. Consultelink:https://docs.netapp.com/us-en/ontap/nfs-config/create-export-policy-task.html["Criação de política de exportação"] elink:https://docs.netapp.com/us-en/ontap/nfs-config/add-rule-export-policy-task.html["Adicionar regra a uma política de exportação"] .
. link:https://docs.netapp.com/us-en/ontap/nfs-config/create-volume-task.html["Criar um volume"] . Lembre-se de marcar a opção de distribuir dados pelo cluster para usar o FlexGroup.
+
image:proxmox-ontap-023.png["Opção FlexGroup"]

. link:https://docs.netapp.com/us-en/ontap/nfs-config/associate-export-policy-flexvol-task.html["Atribuir política de exportação ao volume"]
+
image:proxmox-ontap-008.png["Informações de volume NFS"]

. Notifique o administrador de virtualização que o volume NFS está pronto.


====
.Tarefas de administração de virtualização
[%collapsible%open]
====
. Certifique-se de que pelo menos duas interfaces estejam configuradas em VLANs diferentes (para tolerância a falhas).  Use a ligação NIC.
. Se estiver usando a interface de gerenciamento `https:<proxmox-node>:8006` , clique em datacenter, selecione armazenamento, clique em Adicionar e selecione NFS.
+
image:proxmox-ontap-009.png["Navegação de armazenamento NFS"]

. Preencha os detalhes. Depois de fornecer as informações do servidor, as exportações NFS devem ser preenchidas e selecionadas na lista.  Lembre-se de selecionar as opções de conteúdo.
+
image:proxmox-ontap-010.png["Adição de armazenamento NFS"]

. Para entroncamento de sessão, em todos os hosts Proxmox VE, atualize o arquivo /etc/fstab para montar a mesma exportação NFS usando endereços lif diferentes, juntamente com max_connect e opção de versão NFS.
+
image:proxmox-ontap-011.png["entradas fstab para tronco de sessão"]

. Aqui está o conteúdo em /etc/pve/storage.cfg para NFS.
+
image:proxmox-ontap-012.png["arquivo de configuração de armazenamento para NFS"]



====


== LVM com iSCSI

.Pool compartilhado LVM com iSCSI usando ONTAP
video::d66ef67f-bcc2-4ced-848e-b22e01588e8c[panopto,width=360]
Para configurar o Logical Volume Manager para armazenamento compartilhado entre hosts Proxmox, conclua as seguintes tarefas:

.Tarefas de administração de virtualização
[%collapsible%open]
====
. Certifique-se de que duas interfaces VLAN Linux estejam disponíveis.
. Certifique-se de que o multipath-tools esteja instalado em todos os hosts Proxmox VE.  Certifique-se de que ele inicia na inicialização.
+
[source, shell]
----
apt list | grep multipath-tools
# If need to install, execute the following line.
apt-get install multipath-tools
systemctl enable multipathd
----
. Colete o iqn do host iscsi para todos os hosts Proxmox VE e forneça-o ao administrador de armazenamento.
+
[source, shell]
----
cat /etc/iscsi/initiator.name
----


====
.Tarefas de administração de armazenamento
[%collapsible%open]
====
Se você é novo no ONTAP, use o Gerenciador de Sistema para uma melhor experiência.

. Certifique-se de que o SVM esteja disponível com o protocolo iSCSI habilitado.  Seguirlink:https://docs.netapp.com/us-en/ontap/san-admin/provision-storage.html["Documentação do ONTAP 9"]
. Tenha dois lifs por controlador dedicados para iSCSI.
+
image:proxmox-ontap-013.png["detalhes da interface iscsi"]

. Crie um igroup e preencha os iniciadores iscsi do host.
. Crie o LUN com o tamanho desejado no SVM e apresente-o ao igroup criado na etapa acima.
+
image:proxmox-ontap-014.png["detalhes do iSCSI LUN"]

. Notifique o administrador de virtualização que o LUN foi criado.


====
.Tarefas de administração de virtualização
[%collapsible%open]
====
. Ir para a interface de gerenciamento `https:<proxmox node>:8006` , clique em datacenter, selecione armazenamento, clique em Adicionar e selecione iSCSI.
+
image:proxmox-ontap-015.png["navegação de armazenamento iscsi"]

. Forneça o nome do ID de armazenamento.  O endereço iSCSI lif do ONTAP deve ser capaz de escolher o alvo quando não houver problemas de comunicação.  Como nossa intenção não é fornecer acesso LUN diretamente à VM convidada, desmarque essa opção.
+
image:proxmox-ontap-016.png["criação do tipo de armazenamento iscsi"]

. Agora, clique em Adicionar e selecione LVM.
+
image:proxmox-ontap-017.png["navegação de armazenamento lvm"]

. Forneça o nome do ID do armazenamento e escolha o armazenamento base que deve corresponder ao armazenamento iSCSI que criamos na etapa acima.  Escolha o LUN para o volume base.  Forneça o nome do grupo de volumes.  Certifique-se de que a opção compartilhada esteja selecionada.
+
image:proxmox-ontap-018.png["criação de armazenamento lvm"]

. Aqui está o arquivo de configuração de armazenamento de exemplo para LVM usando volume iSCSI.
+
image:proxmox-ontap-019.png["configuração lvm iscsi"]



====


== LVM com NVMe/TCP

.Pool compartilhado LVM com NVMe/TCP usando ONTAP
video::80164fe4-06db-4c21-a25d-b22e0179c3d2[panopto,width=360]
Para configurar o Logical Volume Manager para armazenamento compartilhado entre hosts Proxmox, conclua as seguintes tarefas:

.Tarefas de administração de virtualização
[%collapsible%open]
====
. Certifique-se de que duas interfaces VLAN Linux estejam disponíveis.
. Em cada host Proxmox no cluster, execute o seguinte comando para coletar informações do iniciador do host.
+
[source, shell]
----
nvme show-hostnqn
----
. Forneça as informações coletadas do host NQN ao administrador de armazenamento e solicite um namespace nvme do tamanho necessário.


====
.Tarefas de administração de armazenamento
[%collapsible%open]
====
Se você é novo no ONTAP, use o Gerenciador de Sistema para uma melhor experiência.

. Certifique-se de que o SVM esteja disponível com o protocolo NVMe habilitado.  Referirlink:https://docs.netapp.com/us-en/ontap/san-admin/create-nvme-namespace-subsystem-task.html["Tarefas NVMe na documentação do ONTAP 9"] .
. Crie o namespace NVMe.
+
image:proxmox-ontap-020.png["criação de namespace nvme"]

. Crie um subsistema e atribua NQNS de host (se estiver usando CLI).  Siga o link de referência acima.
. Notifique o administrador de virtualização que o namespace nvme foi criado.


====
.Tarefas de administração de virtualização
[%collapsible%open]
====
. Navegue até o shell em cada host Proxmox VE no cluster, crie o arquivo /etc/nvme/discovery.conf e atualize o conteúdo específico para seu ambiente.
+
[source, shell]
----
root@pxmox01:~# cat /etc/nvme/discovery.conf
# Used for extracting default parameters for discovery
#
# Example:
# --transport=<trtype> --traddr=<traddr> --trsvcid=<trsvcid> --host-traddr=<host-traddr> --host-iface=<host-iface>

-t tcp -l 1800 -a 172.21.118.153
-t tcp -l 1800 -a 172.21.118.154
-t tcp -l 1800 -a 172.21.119.153
-t tcp -l 1800 -a 172.21.119.154
----
. Faça login no subsistema nvme
+
[source, shell]
----
nvme connect-all
----
. Inspecione e colete detalhes do dispositivo.
+
[source, shell]
----
nvme list
nvme netapp ontapdevices
nvme list-subsys
lsblk -l
----
. Criar grupo de volumes
+
[source, shell]
----
vgcreate pvens02 /dev/mapper/<device id>
----
. Ir para a interface de gerenciamento `https:<proxmox node>:8006` , clique em datacenter, selecione armazenamento, clique em Adicionar e selecione LVM.
+
image:proxmox-ontap-017.png["navegação de armazenamento lvm"]

. Forneça o nome do ID de armazenamento, escolha o grupo de volumes existente e selecione o grupo de volumes que acabou de ser criado com o CLI.  Lembre-se de marcar a opção compartilhada.
+
image:proxmox-ontap-021.png["lvm em vg existente"]

. Aqui está um arquivo de configuração de armazenamento de exemplo para LVM usando NVMe/TCP
+
image:proxmox-ontap-022.png["Configuração tcp lvm em nvme"]



====